"use strict";angular.module("artshopApp.services",[]),angular.module("artshopApp.directives",[]),angular.module("artshopApp",["ngCookies","ngResource","ngSanitize","ngRoute","angularFileUpload","artshopApp.directives","artshopApp.services"]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){a.when("/",{templateUrl:"partials/main",controller:"MainCtrl"}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",authenticate:!0}).when("/piece/create",{templateUrl:"partials/piece-create",controller:"PieceCreateCtrl",authenticate:!0}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status||403===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$routeChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&b.path("/login")})}]),angular.module("artshopApp").controller("MainCtrl",["$scope","PieceService",function(a,b){a.pieces=b.list;var c=function(b){a.pieces=b};b.addToWatchers(c)}]),angular.module("artshopApp").controller("NavbarCtrl",["$scope","$location","Auth",function(a,b,c){a.menu=[{title:"Home",link:"/"},{title:"Pieces",link:"/piece/create"}],console.log(c.isLoggedIn()),a.logout=function(){c.logout().then(function(){b.path("/login")})},a.isActive=function(a){return a===b.path()}}]),angular.module("artshopApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.login=function(d){a.submitted=!0,d.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){c.path("/piece/create")}).catch(function(b){b=b.data,a.errors.other=b.message})}}]),angular.module("artshopApp").controller("SignupCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.type})})}}]),angular.module("artshopApp").controller("SettingsCtrl",["$scope","User","Auth",function(a,b,c){a.errors={},a.changePassword=function(b){a.submitted=!0,b.$valid&&c.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){a.message="Password successfully changed."}).catch(function(){b.password.$setValidity("mongoose",!1),a.errors.other="Incorrect password"})}}]),angular.module("artshopApp").controller("PieceCreateCtrl",["$scope","$upload","PieceService",function(a,b,c){var d={title:"",media:"",dimensionX:0,dimensionY:0,year:"",pieceImg:"",fileUrl:""},e=a.pieceDetails=_.clone(d);a.onFileSelect=function(c){$(".uploading").removeClass("hidden"),c.forEach(function(c){a.upload=b.upload({method:"POST",url:"/api/file",file:c}).progress(function(a){console.log("percent: "+parseInt(100*a.loaded/a.total,10))}).success(function(b){$(".uploading").addClass("hidden"),$(".complete").removeClass("hidden"),setTimeout(function(){$(".complete").addClass("hidden")},2e3),a.pieceDetails.fileUrl=b.fileUrl})})},a.createPiece=function(){c.add(e).then(function(){e=a.pieceDetails=_.clone(d)},function(a){console.log(a)})}}]),angular.module("artshopApp").controller("PiecePreviewListController",["$scope","PieceService",function(a,b){a.pieces=b.list;var c=function(b){a.pieces=b};b.addToWatchers(c)}]),angular.module("artshopApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(a,d){var e=d||angular.noop;return c.save({email:a.email,password:a.password},function(a){return b.currentUser=a,e()},function(a){return e(a)}).$promise},logout:function(a){var d=a||angular.noop;return c.delete(function(){return b.currentUser=null,d()},function(a){return d(a)}).$promise},createUser:function(a,c){var e=c||angular.noop;return d.save(a,function(a){return b.currentUser=a,e(a)},function(a){return e(a)}).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.update({oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},currentUser:function(){return d.get()},isLoggedIn:function(){var a=b.currentUser;return!!a}}}]),angular.module("artshopApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("artshopApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("artshopApp.services").factory("PieceService",["$resource",function(a){var b=a("/api/piece/:pieceId",{pieceId:"@pieceId"},{update:{method:"PUT"}}),c=function(){this.list=[],this.watchers=[],this.getList()};return c.prototype.add=function(a){var c=new b(a);return c.$save(function(a){this.updateList([a].concat(this.list))}.bind(this))},c.prototype.remove=function(a){var b=function(b){return b._id===a},c=this.list.filter(b)[0];c.$remove({pieceId:c._id},function(){this.updateList(_.reject(this.list,b))}.bind(this))},c.prototype.setPieceAsSold=function(a){var b=function(b){return b._id===a},c=this.list.filter(b)[0];c.sold=!0,this.updateSubscribers()},c.prototype.getList=function(){var a=b.query(function(){this.updateList(a)}.bind(this))},c.prototype.updateList=function(a){this.list=a,this.updateSubscribers()},c.prototype.addToWatchers=function(a){this.watchers.push(a)},c.prototype.updateSubscribers=function(){this.watchers.forEach(function(a){a(this.list)},this)},new c}]),angular.module("artshopApp.services").factory("ChargeService",["PieceService","$resource",function(a,b){var c=b("/api/charge"),d=_.template("Thanks for buying <%=title %>, I'll be in touch soon to organise shipping it out to you"),e=function(){};return e.prototype.sendCharge=function(b){var e=new c(b);e.$save(function(b){a.setPieceAsSold(b._id),window.alert(d({title:b.title}))})},new e}]),angular.module("artshopApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("artshopApp.directives").directive("removeImage",["PieceService",function(a){return{restrict:"A",link:function(b,c){var d=function(){a.remove($(this).parent().attr("id"),b)};$(c).click(d)}}}]),angular.module("artshopApp.directives").directive("stripe",["ChargeService",function(a){return{restrict:"A",link:function(b,c){var d,e,f={key:Bootstrap.pk,image:"/images/joe_pattern.jpg",token:function(b,c){a.sendCharge({token:b,id:d,args:c,description:e+" - "+d})}},g=StripeCheckout.configure(f),h=function(){d=$(this).attr("id"),e=$(this).parent().siblings("img").attr("alt"),g.open({name:"Joeseph Coveney",description:e,amount:Bootstrap.price,shippingAddress:!0,currency:"EUR"})};$(c).click(h)}}}]);